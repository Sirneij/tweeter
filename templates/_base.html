<!DOCTYPE html>
<html lang="en">
  {% load static %}

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tweeter {% block title %} {% endblock title %}</title>
    <link rel="stylesheet" href="{% static 'tweeter/css/all.css' %}" />
    <link rel="stylesheet" href="{% static 'tweeter/css/main.css' %}" />
    <style>
      .submit-btn {
        margin: 0;
        width: 2rem;
        background-color: #fff;
        color: #1aa1f5;
        padding: 0.7rem 0.5rem;
        border: 0 solid #1aa1f5;
        border-radius: 2rem;
        font-size: 1rem;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <section class="feeds-page">
      {% include 'includes/_nav.html' %} {%block content%} {%endblock content%}
    </section>
    <script>
      const postBtn = document.querySelector(".post-btn");
      const modalWrapper = document.querySelector(".modal-wrapper");
      const modal = document.querySelector(".modal");
      const postModalX = document.querySelector(".modal-header i");
      const modalPostBtn = document.querySelector(".modal-header button");
      const modalFooterPlus = document.querySelector(".modal-footer span");
      const modalInput = document.querySelector(".modal-input");
      const user = document.querySelector(".user");
      const sidebar = document.querySelector(".sidebar");
      const sidebarWrapper = document.querySelector(".sidebar-wrapper");
      const xBtn = document.querySelector(".sidebar-header i");
      // News feed page
      // Post modal
      postBtn.addEventListener("click", () => {
        modal.style.display = "block";
        modalWrapper.classList.add("modal-wrapper-display");
      });

      const changeOpacity = (x) => {
        modalPostBtn.style.opacity = x;
        modalFooterPlus.style.opacity = x;
      };

      postModalX.addEventListener("click", () => {
        modal.style.display = "none";
        modalWrapper.classList.remove("modal-wrapper-display");

        if (modalInput.value !== "") {
          modalInput.value = "";
          changeOpacity(0.5);
        }
      });

      modalInput.addEventListener("keypress", (e) => {
        if (e.target.value !== "") {
          changeOpacity(1);
        }
      });

      modalInput.addEventListener("blur", (e) => {
        if (e.target.value === "") {
          changeOpacity(0.5);
        }
      });

      // Sidebar
      user.addEventListener("click", () => {
        sidebar.classList.add("sidebar-display");
        sidebarWrapper.classList.add("sidebar-wrapper-display");
      });

      xBtn.addEventListener("click", () => {
        sidebar.classList.remove("sidebar-display");
        sidebarWrapper.classList.remove("sidebar-wrapper-display");
      });

      // dark mode
      const toggle = document.querySelector(".toggle");
      const circle = document.querySelector(".circle");
      const darkElements1 = document.querySelectorAll(".dark-mode-1");
      const darkElements2 = document.querySelectorAll(".dark-mode-2");
      const lighTexts = document.querySelectorAll(".light-text");
      const borders = document.querySelectorAll(".border");

      toggle.addEventListener("click", () => {
        circle.classList.toggle("move");
        Array.from(darkElements1).map((darkEl1) =>
          darkEl1.classList.toggle("dark-1")
        );
        Array.from(darkElements2).map((darkEl2) =>
          darkEl2.classList.toggle("dark-2")
        );
        Array.from(lighTexts).map((lighText) =>
          lighText.classList.toggle("light")
        );
        Array.from(borders).map((border) =>
          border.classList.toggle("border-color")
        );
      });

      // Handle feed form

      function errorDisplay(msg, display) {
        let errorContainer = document.getElementById("error");
        if (display === true) {
          errorContainer.setAttribute("class", "d-block alert alert-danger");
          errorContainer.innerHTML = msg;
        } else {
          errorContainer.setAttribute("class", "d-none alert alert-danger");
        }
      }
      let tweetsContainer = document.getElementById("tweets");
      let tweetCreateForm = document.getElementById("tweet-form");
      let tweetCreateFormModal = document.getElementById("tweet-form-modal");
      tweetCreateForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const myForm = e.target;
        const formData = new FormData(myForm);
        const url = myForm.getAttribute("action");
        const method = myForm.getAttribute("method");
        const response = "json";
        const xhr = new XMLHttpRequest();
        xhr.responseType = response;
        xhr.open(method, url);
        xhr.setRequestHeader("HTTP_X_REQUESTED_WITH", "XMLHttpRequest");
        xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
        xhr.onload = () => {
          if (xhr.status === 201) {
            errorDisplay("", false);
            const newTweetJson = xhr.response;
            const tweetElement = formatTweetElement(newTweetJson);
            const tempHTML = tweetsContainer.innerHTML;
            tweetsContainer.innerHTML = tweetElement + tempHTML;

            myForm.reset();
            modal.style.display = "none";
            modalWrapper.classList.remove("modal-wrapper-display");
            if (modalInput.value !== "") {
              modalInput.value = "";
              changeOpacity(0.5);
            }
          } else if (xhr.status === 400) {
            const errorJson = xhr.response;
            const errorContent = errorJson.content;
            let errorContentMessage;
            if (errorContent) {
              errorContentMessage = errorContent[0];
              if (errorContentMessage) {
                errorDisplay(errorContentMessage, true);
              } else {
                alert("An error has occured. Kindly try again...");
              }
            } else {
              alert("An error has occured. Kindly try again...");
            }
          }
        };
        xhr.onerror = () => {
          alert("Oopps! An error occurred. Please try again later...");
        };
        xhr.send(formData);
      });

      tweetCreateFormModal.addEventListener("submit", function (e) {
        e.preventDefault();
        const myForm = e.target;
        const formData = new FormData(myForm);
        const url = myForm.getAttribute("action");
        const method = myForm.getAttribute("method");
        const response = "json";
        const xhr = new XMLHttpRequest();
        xhr.responseType = response;
        xhr.open(method, url);
        xhr.setRequestHeader("HTTP_X_REQUESTED_WITH", "XMLHttpRequest");
        xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
        xhr.onload = () => {
          if (xhr.status === 201) {
            errorDisplay("", false);
            const newTweetJson = xhr.response;
            const tweetElement = formatTweetElement(newTweetJson);
            const tempHTML = tweetsContainer.innerHTML;
            tweetsContainer.innerHTML = tweetElement + tempHTML;
            myForm.reset();
          } else if (xhr.status === 400) {
            const errorJson = xhr.response;
            const errorContent = errorJson.content;
            let errorContentMessage;
            if (errorContent) {
              errorContentMessage = errorContent[0];
              if (errorContentMessage) {
                errorDisplay(errorContentMessage, true);
              } else {
                alert("An error has occured. Kindly try again...");
              }
            } else {
              alert("An error has occured. Kindly try again...");
            }
          }
        };
        xhr.onerror = () => {
          alert("Oopps! An error occurred. Please try again later...");
        };
        xhr.send(formData);
      });

      function formatTweetElement(tweet) {
        let formattedTweet =
          ' <div class="post border" id="tweet-' +
          tweet.id +
          '"><div class="user-avatar"><img src="{% static "tweeter/images/user2.jpg" %}" /></div><div class="post-content"><div class="post-user-info light-text"><h4>Helen Brown</h4><i class="fas fa-check-circle"></i><span>@helenbrown 15m</span></div><p class="post-text light-text">' +
          tweet.content +
          '</p><div class="post-img"><img src="{% static "tweeter/images/post-img-1.jpg" %}" /></div><div class="post-icons"><i class="far fa-comment"></i><i class="fas fa-retweet"></i><i class="far fa-heart"></i><i class="fas fa-share-alt"></i></div></div></div>';
        return formattedTweet;
      }
      const loadTweets = function (tweetElement) {
        const xhr = new XMLHttpRequest();
        const method = "GET";
        const response = "json";
        const url = "/tweets";

        xhr.responseType = response;
        xhr.open(method, url);
        xhr.onload = () => {
          let responseFromView = xhr.response;
          let items = responseFromView; //the last response is coming from the data
          let finalTweetStr = "";

          for (let i = 0; i < items.length; i++) {
            let tweetObj = items[i];
            let currentItem = formatTweetElement(tweetObj);
            finalTweetStr += currentItem;
          }
          tweetsContainer.innerHTML = finalTweetStr;
        };
        xhr.send();
      };
      loadTweets(tweets);
    </script>

    {% block scripts %} {% endblock scripts %}
  </body>
</html>
